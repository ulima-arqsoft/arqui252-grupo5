> [4. Decisiones Iniciales de Arquitectura](../4.md) ‚Ä∫ [4.2. M√≥dulo Autenticaci√≥n y Usuarios / Pedro Morales](4.2.md)

# Autenticaci√≥n y Usuarios / Pedro Morales

## Decisiones de Asignaci√≥n de Responsabilidades  

### Decisi√≥n 1:

**T√≠tulo**  
- Separaci√≥n del servicio de autenticaci√≥n como m√≥dulo independiente

**Contexto**  
- El sistema requiere garantizar seguridad, escalabilidad y trazabilidad en los procesos de registro, inicio de sesi√≥n, recuperaci√≥n de cuenta y gesti√≥n de sesiones.  
- Se identific√≥ la necesidad de desacoplar la autenticaci√≥n del resto de la l√≥gica de negocio (generaci√≥n de playlists, preferencias, etc.) para aislar posibles vulnerabilidades.  

**Alternativas**  
- Integrar la autenticaci√≥n dentro del backend general.  
- Usar un servicio externo de autenticaci√≥n (Auth0, Firebase Auth).  
- Implementar un microservicio interno especializado en autenticaci√≥n.  

**Criterios de Elecci√≥n**  
- Control total sobre pol√≠ticas de seguridad y almacenamiento de usuarios.  
- Escalabilidad independiente del core funcional.  
- Capacidad de auditor√≠a y personalizaci√≥n de tokens.  

**Decisi√≥n**  
- **Implementar un microservicio interno de autenticaci√≥n (Auth Service) encargado exclusivamente del registro, login, emisi√≥n y revocaci√≥n de tokens.**  

**Sustento**  
- Permite mantener la seguridad como dominio aislado con control granular de sesiones y auditor√≠a.  
- Facilita la futura integraci√≥n con proveedores externos mediante OAuth 2.0 sin alterar la l√≥gica principal del sistema.  

---

### Decisi√≥n 2:

**T√≠tulo**  
- Asignaci√≥n de responsabilidades entre los servicios de Usuario, Privacidad y Notificaciones  

**Contexto**  
- La aplicaci√≥n gestiona m√∫ltiples aspectos del usuario: autenticaci√≥n, perfil, l√≠nea de tiempo, consentimiento y comunicaci√≥n.  
- Centralizar todas estas responsabilidades en un solo m√≥dulo afectar√≠a la mantenibilidad y la velocidad de respuesta del sistema.  

**Alternativas**  
- Mantener toda la gesti√≥n de usuarios en un √∫nico m√≥dulo monol√≠tico.  
- Dividir las funciones en subm√≥dulos especializados: Auth Service, User Profile Service, Privacy Service y Notification Service.  

**Criterios de Elecci√≥n**  
- Separaci√≥n clara de dominios (Single Responsibility Principle).  
- Sincronizaci√≥n controlada entre servicios.  
- Independencia para despliegues y pruebas por m√≥dulo.  

**Decisi√≥n**  
- **Dividir la responsabilidad del m√≥dulo en cuatro subcomponentes: Auth Service (autenticaci√≥n), User Profile (perfil e historial), Privacy Service (consentimientos) y Notification Service (comunicaci√≥n).**  

**Sustento**  
- Mejora la trazabilidad y el mantenimiento al permitir que cada servicio evolucione de forma independiente.  
- Facilita la identificaci√≥n y resoluci√≥n de fallas en un componente espec√≠fico sin afectar los dem√°s.  

---

### Decisi√≥n 3:

**T√≠tulo**  
- Responsabilidad compartida en seguridad y control de acceso entre Auth Service y API Gateway  

**Contexto**  
- El sistema requiere un nivel alto de protecci√≥n frente a intentos de fuerza bruta, sesiones m√∫ltiples y accesos no autorizados.  
- Los endpoints deben ser protegidos tanto a nivel de token (l√≥gica de negocio) como a nivel de tr√°fico de red.  

**Alternativas**  
- Delegar toda la seguridad al backend.  
- Utilizar un firewall externo sin validaci√≥n de tokens.  
- Implementar una responsabilidad compartida entre Auth Service (validaci√≥n de tokens) y API Gateway (filtrado y rate limiting).  

**Criterios de Elecci√≥n**  
- Reducci√≥n de carga en el backend por validaciones redundantes.  
- Mayor defensa en profundidad (‚Äúdefense in depth‚Äù).  
- Monitoreo centralizado del tr√°fico y detecci√≥n temprana de anomal√≠as.  

**Decisi√≥n**  
- **Establecer una capa doble de seguridad: el API Gateway maneja el rate limiting y WAF, mientras que el Auth Service valida tokens y gestiona el control de sesiones.**  

**Sustento**  
- Se garantiza un control integral de acceso y detecci√≥n temprana de amenazas sin comprometer el rendimiento.  
- Facilita la trazabilidad de eventos de seguridad al centralizar logs y auditor√≠as en el Gateway y el Auth Service.  

---
---

## Decisiones de Modelo de Datos

### Decisi√≥n 1:

**T√≠tulo**  
- Dise√±o del modelo de usuario con enfoque en seguridad y extensibilidad  

**Contexto**  
- El m√≥dulo requiere almacenar informaci√≥n de usuario que incluya credenciales, perfil y preferencias, sin comprometer la seguridad.  
- Adem√°s, se busca permitir futuras integraciones con servicios externos como Spotify o Google mediante OAuth.  

**Alternativas**  
- Modelo de usuario monol√≠tico con todos los campos en una sola tabla.  
- Separar credenciales y datos de perfil en diferentes entidades.  
- Usar un esquema NoSQL para mayor flexibilidad en atributos.  

**Criterios de Elecci√≥n**  
- Seguridad en el almacenamiento de credenciales.  
- Escalabilidad y f√°cil mantenimiento.  
- Compatibilidad con relaciones y auditor√≠as.  

**Decisi√≥n**  
- **Separar los datos en entidades l√≥gicas: `users` (credenciales b√°sicas), `user_profile` (datos personales) y `user_settings` (preferencias y visibilidad).**  

**Sustento**  
- Permite mantener las credenciales aisladas del resto de la informaci√≥n del usuario, reduciendo el riesgo en caso de brecha.  
- Facilita la extensi√≥n del perfil con nuevos atributos sin alterar la estructura principal.  

---

### Decisi√≥n 2:

**T√≠tulo**  
- Implementaci√≥n de almacenamiento seguro y cifrado de datos sensibles  

**Contexto**  
- El sistema maneja contrase√±as, correos y tokens que deben cumplir con est√°ndares de seguridad y privacidad (GDPR, OWASP).  
- Se necesita asegurar la trazabilidad y proteger la informaci√≥n frente a ataques o accesos no autorizados.  

**Alternativas**  
- Almacenar contrase√±as y correos en texto plano (no viable).  
- Usar hash est√°ndar (MD5/SHA1).  
- Aplicar hashing con bcrypt y cifrado AES-256 para datos sensibles.  

**Criterios de Elecci√≥n**  
- Cumplimiento de buenas pr√°cticas OWASP.  
- Capacidad de auditar accesos y fallos de seguridad.  
- Bajo impacto en rendimiento de consultas.  

**Decisi√≥n**  
- **Usar hash bcrypt + salt para contrase√±as y cifrado AES-256 para correos, tokens y datos sensibles.**  

**Sustento**  
- Garantiza protecci√≥n en reposo y evita la reversi√≥n de contrase√±as.  
- Cumple est√°ndares de seguridad modernos sin afectar la velocidad de lectura.  

---

### Decisi√≥n 3:

**T√≠tulo**  
- Estructura de almacenamiento para sesiones, consentimientos y auditor√≠as  

**Contexto**  
- El sistema requiere registrar sesiones activas, consentimientos informados y eventos de auditor√≠a por usuario.  
- Estos datos deben mantenerse separados para escalar y permitir auditor√≠as legales o de soporte.  

**Alternativas**  
- Unificar todo en una sola tabla de ‚Äúactividad de usuario‚Äù.  
- Crear tablas independientes para cada tipo de registro.  
- Utilizar una base NoSQL para eventos.  

**Criterios de Elecci√≥n**  
- Mantenibilidad y trazabilidad de acciones.  
- Consultas r√°pidas y segmentadas por tipo de evento.  
- Posibilidad de auditor√≠as hist√≥ricas.  

**Decisi√≥n**  
- **Crear tres entidades separadas: `session_tokens` (gesti√≥n de sesiones activas), `consent_logs` (versionado de consentimientos) y `audit_logs` (registro inmutable de eventos).**  

**Sustento**  
- Facilita la depuraci√≥n y auditor√≠a al mantener un hist√≥rico completo de cambios.  
- Permite escalar cada componente (sesiones, consentimientos, auditor√≠a) de forma independiente seg√∫n la carga o necesidad legal.  

--- 
---

## Decisiones de Elecci√≥n de Tecnolog√≠a

### Decisi√≥n 1:

**T√≠tulo**  
- Selecci√≥n de Node.js con Express como framework backend para autenticaci√≥n  

**Contexto**  
- El m√≥dulo requiere manejar m√∫ltiples flujos de autenticaci√≥n (registro, login, OAuth, recuperaci√≥n de cuenta) con alta concurrencia y baja latencia.  
- Se busca una tecnolog√≠a con ecosistema maduro, soporte de bibliotecas de seguridad (JWT, OAuth 2.0) y facilidad para integrarse con microservicios.  

**Alternativas**  
- Python (Django/Flask)  
- Java (Spring Boot)  
- Node.js (Express/NestJS)  

**Criterios de Elecci√≥n**  
- Rendimiento en entornos de I/O intensivo.  
- Ecosistema de librer√≠as modernas para seguridad y autenticaci√≥n.  
- Curva de aprendizaje baja y comunidad activa.  

**Decisi√≥n**  
- **Adoptar Node.js con Express para el desarrollo del microservicio de autenticaci√≥n.**  

**Sustento**  
- Permite manejar peticiones concurrentes con bajo consumo de recursos.  
- Facilita la integraci√≥n con servicios OAuth y APIs REST ya existentes en el sistema.  

---

### Decisi√≥n 2:

**T√≠tulo**  
- Selecci√≥n de PostgreSQL como base de datos principal del m√≥dulo de usuarios  

**Contexto**  
- El m√≥dulo necesita almacenar informaci√≥n estructurada (usuarios, sesiones, consentimientos) y datos semiestructurados (preferencias, historial) con consistencia y seguridad.  
- Es esencial mantener integridad referencial y soporte de auditor√≠a con logs inmutables.  

**Alternativas**  
- MySQL  
- MongoDB  
- PostgreSQL  

**Criterios de Elecci√≥n**  
- Soporte de JSONB para campos flexibles.  
- Integridad referencial y transaccionalidad ACID.  
- Seguridad avanzada y roles granulares.  

**Decisi√≥n**  
- **Usar PostgreSQL como base de datos principal, aprovechando su estructura relacional y soporte JSONB para datos de usuario.**  

**Sustento**  
- Permite modelar relaciones complejas entre usuarios, sesiones y consentimientos.  
- Combina la seguridad y consistencia de una base SQL con flexibilidad semiestructurada.  

---

### Decisi√≥n 3:

**T√≠tulo**  
- Integraci√≥n de servicios externos: OAuth, mensajer√≠a y monitoreo  

**Contexto**  
- El m√≥dulo debe conectarse a servicios externos para inicio de sesi√≥n social (Spotify, Google, Apple), env√≠o de correos de verificaci√≥n y notificaciones push.  
- Se busca garantizar confiabilidad, entrega oportuna y trazabilidad.  

**Alternativas**  
- Desarrollar soluciones internas de correo y push.  
- Usar servicios administrados externos.  

**Criterios de Elecci√≥n**  
- Confiabilidad del proveedor y SLA garantizado.  
- Facilidad de integraci√≥n mediante SDKs o APIs REST.  
- Coste y escalabilidad del servicio.  

**Decisi√≥n**  
- **Integrar servicios externos especializados: OAuth 2.0 para autenticaci√≥n social, SendGrid para correos y Firebase Cloud Messaging (FCM) para notificaciones push.**  

**Sustento**  
- Reduce la complejidad de mantenimiento y mejora la entrega de mensajes cr√≠ticos (verificaci√≥n, 2FA).  
- Garantiza la compatibilidad con los principales ecosistemas m√≥viles y web, manteniendo trazabilidad mediante logs y paneles de monitoreo.  

---
---

## Decisiones de Tiempo de Enlace

### Decisi√≥n 1:

**T√≠tulo**  
- Configuraci√≥n de dependencias y librer√≠as de autenticaci√≥n en tiempo de compilaci√≥n  

**Contexto**  
- El servicio de autenticaci√≥n depende de librer√≠as externas (JWT, bcrypt, OAuth, nodemailer, etc.) que deben estar estandarizadas para todos los entornos de despliegue.  
- Es necesario garantizar que todas las dependencias cr√≠ticas se resuelvan durante el proceso de build para evitar errores en producci√≥n.  

**Alternativas**  
- Resolver dependencias en tiempo de ejecuci√≥n.  
- Resolver dependencias en tiempo de compilaci√≥n con control de versiones.  
- Usar contenedores con dependencias preinstaladas.  

**Criterios de Elecci√≥n**  
- Consistencia entre entornos (dev, staging, prod).  
- Evitar fallos por versiones incompatibles.  
- Facilitar despliegues automatizados (CI/CD).  

**Decisi√≥n**  
- **Resolver las dependencias cr√≠ticas en tiempo de compilaci√≥n mediante archivo `package-lock.json` y validaciones en el pipeline CI/CD.**  

**Sustento**  
- Garantiza estabilidad y reproducibilidad del entorno de ejecuci√≥n.  
- Permite detectar conflictos de librer√≠as antes del despliegue.  

---

### Decisi√≥n 2:

**T√≠tulo**  
- Enlace din√°mico de servicios externos (OAuth, SendGrid, Firebase) mediante variables de entorno  

**Contexto**  
- El sistema se conecta a servicios externos cuyos tokens y credenciales cambian con frecuencia y no deben estar embebidos en el c√≥digo fuente.  
- Se necesita flexibilidad para modificar configuraciones sin recompilar el sistema.  

**Alternativas**  
- Definir credenciales est√°ticamente en el c√≥digo.  
- Usar variables de entorno en tiempo de ejecuci√≥n.  
- Configurar un gestor de secretos centralizado (Vault).  

**Criterios de Elecci√≥n**  
- Seguridad de las credenciales.  
- Facilidad de actualizaci√≥n sin downtime.  
- Compatibilidad con el pipeline de despliegue.  

**Decisi√≥n**  
- **Implementar un enlace din√°mico a servicios externos usando variables de entorno (`.env`) inyectadas en tiempo de ejecuci√≥n por el orquestador (Docker/CI).**  

**Sustento**  
- Permite cambiar credenciales y endpoints sin recompilar el servicio.  
- Refuerza la seguridad al evitar exponer secretos en el c√≥digo fuente.  

---

### Decisi√≥n 3:

**T√≠tulo**  
- Enlace diferido para m√≥dulos opcionales (notificaciones y auditor√≠a)  

**Contexto**  
- Algunos m√≥dulos, como notificaciones push y registros de auditor√≠a, no son cr√≠ticos para la autenticaci√≥n base y pueden activarse o desactivarse seg√∫n el entorno.  
- Se busca mantener bajo consumo de recursos en entornos de desarrollo o pruebas unitarias.  

**Alternativas**  
- Enlazar todos los m√≥dulos durante la compilaci√≥n.  
- Enlazar m√≥dulos opcionales din√°micamente en tiempo de ejecuci√≥n.  
- Mantener microservicios separados siempre activos.  

**Criterios de Elecci√≥n**  
- Optimizaci√≥n de recursos.  
- Flexibilidad para pruebas.  
- Independencia funcional del core de autenticaci√≥n.  

**Decisi√≥n**  
- **Utilizar enlace diferido en tiempo de ejecuci√≥n para m√≥dulos opcionales, carg√°ndolos √∫nicamente cuando las variables de entorno los habiliten.**  

**Sustento**  
- Mejora la eficiencia y reduce el uso de memoria en entornos de desarrollo.  
- Permite habilitar funcionalidades avanzadas (como auditor√≠a o notificaciones) sin modificar el core ni requerir un nuevo build.  

---
---

[‚¨ÖÔ∏è Anterior](../4.1/4.1.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../4.3/4.3.md)