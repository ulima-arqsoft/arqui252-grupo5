> [4. Decisiones Iniciales de Arquitectura](../4.md) ‚Ä∫ [4.3. M√≥dulo Gesti√≥n de Planes y Suscripciones / Leonardo Salazar](4.3.md)

# 4.3. Gesti√≥n de Planes y Suscripciones / Leonardo Salazar

## **Decisi√≥n 1 ‚Äì Asignaci√≥n de Responsabilidades**

### **T√≠tulo**
Separaci√≥n de responsabilidades entre la l√≥gica de suscripci√≥n, procesamiento de pagos y gesti√≥n de usuarios.

### **Contexto**
El m√≥dulo de Gesti√≥n de Planes y Suscripciones debe permitir a los usuarios de **LYRA** acceder a planes gratuitos o premium mediante pagos recurrentes.  
Es cr√≠tico garantizar que la l√≥gica de negocio de los planes no interfiera con la validaci√≥n de pagos ni con el manejo de usuarios.  
Dado que el equipo trabaja en un backend compartido con otros m√≥dulos, es necesario mantener una separaci√≥n clara para asegurar **mantenibilidad, trazabilidad y escalabilidad futura** (por ejemplo, integrar nuevos m√©todos de pago).

### **Alternativas**
1. **L√≥gica centralizada en un √∫nico servicio de backend**
   - Todas las funcionalidades (planes, pagos, usuarios) se manejan en el mismo m√≥dulo.  
   - Reduce la complejidad inicial, pero **genera acoplamiento** entre componentes y **dificulta la evoluci√≥n**.

2. **L√≥gica distribuida por subm√≥dulos especializados**
   - Un subm√≥dulo para planes y beneficios, otro para procesamiento de pagos (v√≠a pasarela externa), y otro para vinculaci√≥n con el usuario.  
   - Mayor **independencia**, facilita **pruebas y mantenimiento**.

### **Criterios de Elecci√≥n**
- Mantenibilidad del c√≥digo.  
- Escalabilidad para agregar nuevos medios de pago.  
- Trazabilidad y separaci√≥n de responsabilidades.  
- Facilidad de integraci√≥n con APIs externas (Stripe, PayPal).

### **Decisi√≥n**
Se adopta un modelo distribuido por subm√≥dulos especializados.

### **Sustento**
Separar la l√≥gica en subm√≥dulos permite reducir el acoplamiento y mejorar la claridad del c√≥digo.  
Adem√°s, facilita el reemplazo o actualizaci√≥n de componentes (por ejemplo, cambiar la pasarela de pagos sin alterar el manejo de planes).  
Esto mejora la mantenibilidad y reduce el riesgo de fallas cruzadas entre pagos y usuarios.

---

## **Decisi√≥n 2 ‚Äì Modelo de Datos**

### **T√≠tulo**
Elecci√≥n entre modelo de datos relacional vs documental para el manejo de planes y transacciones.

### **Contexto**
El m√≥dulo gestiona informaci√≥n estructurada como usuarios, planes, fechas de renovaci√≥n y transacciones.  
Estas entidades requieren **consistencia** y **cumplimiento de reglas financieras** (por ejemplo, evitar duplicar pagos y mantener integridad entre plan y usuario).  
Sin embargo, tambi√©n se registran logs y recibos, que pueden variar en estructura.

### **Alternativas**
1. **Modelo Relacional (PostgreSQL)**
   - Soporte a **transacciones ACID**.  
   - Integridad referencial entre usuarios y pagos.  
   - Ideal para consultas estructuradas (planes activos, historial de pagos).

2. **Modelo Documental (MongoDB)**
   - Mayor **flexibilidad de esquemas**.  
   - Permite guardar logs o recibos con formatos distintos.  
   - Menor rigidez, pero **menos control de integridad** entre entidades.

### **Criterios de Elecci√≥n**
- Integridad y consistencia de datos financieros.  
- Soporte transaccional.  
- Compatibilidad con otras partes del sistema (usuarios).  
- Requerimientos regulatorios de los pagos.

### **Decisi√≥n**
Se elige un modelo relacional (PostgreSQL).

### **Sustento**
El manejo de pagos y planes requiere transacciones consistentes y relaciones claras entre usuarios, suscripciones y facturas.  
PostgreSQL ofrece soporte nativo a ACID y control referencial, asegurando la confiabilidad de los datos financieros.  
Adem√°s, su compatibilidad con JSON permite almacenar logs o metadatos cuando se necesite flexibilidad.

---

## **Decisi√≥n 3 ‚Äì Elecci√≥n de Tecnolog√≠a**

### **T√≠tulo**
Selecci√≥n de tecnolog√≠a de backend y pasarela de pago para el m√≥dulo de suscripciones.

### **Contexto**
El m√≥dulo debe integrarse con el backend principal de LYRA y procesar pagos seguros con tarjetas o billeteras digitales.  
Es fundamental minimizar los riesgos de manejo directo de datos bancarios y cumplir con normativas de seguridad.

### **Alternativas**
1. **Integraci√≥n con pasarela Stripe API**
   - SDK y API REST con soporte para pagos recurrentes.  
   - Cumple con **PCI DSS** y enmascara datos de tarjetas.  
   - Excelente documentaci√≥n y f√°cil integraci√≥n con Node.js.

2. **Integraci√≥n con PayPal REST API**
   - Amplio uso y reconocimiento.  
   - Permite pagos √∫nicos o recurrentes.  
   - Configuraci√≥n m√°s extensa y menos flexible para suscripciones din√°micas.

### **Criterios de Elecci√≥n**
- Cumplimiento de normas de seguridad.  
- Facilidad de integraci√≥n con NestJS.  
- Soporte para pagos recurrentes.  
- Soporte t√©cnico y documentaci√≥n.

### **Decisi√≥n**
Se elige Stripe API como pasarela de pago principal.

### **Sustento**
Stripe ofrece un manejo seguro de **tokens de pago** y soporte para **planes recurrentes**.  
Reduce la exposici√≥n de datos sensibles al delegar el proceso de cobro a su API certificada.  
Adem√°s, su SDK simplifica la gesti√≥n de **renovaciones y cancelaciones**, aline√°ndose con la arquitectura modular de LYRA.

---

## **Decisi√≥n 4 ‚Äì Tiempo de Enlace**

### **T√≠tulo**
Definici√≥n del momento de configuraci√≥n de credenciales y par√°metros de integraci√≥n con la pasarela de pago.

### **Contexto**
El m√≥dulo requiere **credenciales privadas (keys)** para comunicarse con la API de Stripe.  
Estas credenciales deben mantenerse seguras, pero tambi√©n permitir **actualizaciones** (por ejemplo, cambio de entorno o rotaci√≥n de claves).

### **Alternativas**
1. **Configuraci√≥n en tiempo de compilaci√≥n (hardcoded o en archivos locales)**
   - Simplicidad en entornos de desarrollo.  
   - Mayor riesgo de exposici√≥n de claves en repositorios.

2. **Configuraci√≥n en tiempo de despliegue (variables de entorno)**
   - Permite cambiar credenciales sin modificar el c√≥digo.  
   - Compatible con servicios cloud (Vercel, AWS, Render).

3. **Configuraci√≥n din√°mica en tiempo de ejecuci√≥n**
   - Permite al sistema cargar nuevas credenciales desde un servicio de configuraci√≥n.  
   - Requiere un mecanismo de autenticaci√≥n adicional.

### **Criterios de Elecci√≥n**
- Seguridad de las credenciales.  
- Facilidad de despliegue y mantenimiento.  
- Separaci√≥n entre entornos (dev, staging, prod).

### **Decisi√≥n**
‚úÖ Se define la **configuraci√≥n en tiempo de despliegue** mediante variables de entorno.

### **Sustento**
Esta estrategia permite mantener las **claves seguras y flexibles**, evitando su exposici√≥n en repositorios.  
Adem√°s, facilita la **gesti√≥n de entornos** y el cumplimiento de **buenas pr√°cticas de DevSecOps**, garantizando la continuidad del servicio incluso ante rotaci√≥n de credenciales.

---

[‚¨ÖÔ∏è Anterior](../4.2/4.2.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../4.4/4.4.md)