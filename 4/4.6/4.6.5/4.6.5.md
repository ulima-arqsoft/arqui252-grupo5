> [4. Decisiones Iniciales de Arquitectura](../../4.md) ‚Ä∫ [4.6. Listado Consolidado](../4.6.md) ‚Ä∫ [4.6.5. Modelo de Coordinaci√≥n](4.6.5.md)

# 4.6.5. Modelo de Coordinaci√≥n

### Decisi√≥n 1:

**T√≠tulo**  
- Sincron√≠a en el borde (UX) y asincron√≠a en el n√∫cleo (trabajo pesado)

**Contexto**  
- La app combina acciones que el usuario espera ‚Äúal instante‚Äù (login, verificar emoci√≥n, ver perfil) con tareas que pueden tardar (crear/exportar playlist, enviar correos/notificaciones, conciliar con Spotify/pagos). Una misma llamada puede involucrar varios m√≥dulos.

**Alternativas**  
- A) Todo s√≠ncrono entre servicios (llamada encadenada: App ‚Üí Auth ‚Üí Playlists ‚Üí Integraciones).  
- B) Todo as√≠ncrono v√≠a eventos/colas (la App siempre ‚Äúdeja pedido‚Äù y consulta luego).  
- C) **H√≠brido:** interacciones de interfaz s√≠ncronas; trabajo pesado y no cr√≠tico, as√≠ncrono.

**Criterios de Elecci√≥n**  
- Experiencia fluida (tiempos de respuesta <2‚Äì5 s).  
- Estabilidad bajo picos de carga.  
- Aislar fallas de proveedores externos (Spotify, pasarela pago).  
- Simplicidad de implementaci√≥n y soporte.

**Decisi√≥n**  
- **C) H√≠brido:** S√≠ncrono para operaciones de cara al usuario y lectura inmediata; as√≠ncrono (colas/eventos) para procesos largos o integraciones externas.

**Sustento**  
- Mejora la percepci√≥n de rapidez sin bloquear por tareas lentas.  
- Reduce el acoplamiento entre m√≥dulos y permite reintentos/recuperaci√≥n sin afectar la UI.

---

### Decisi√≥n 2:

**T√≠tulo**  
- Coordinaci√≥n entre m√≥dulos con Sagas, ‚Äúoutbox‚Äù e idempotencia

**Contexto**  
- Flujos que tocan m√∫ltiples m√≥dulos (p. ej., suscripci√≥n paga ‚Üí cambio de plan ‚Üí l√≠mites en generaci√≥n ‚Üí facturaci√≥n; o ‚Äúcrear playlist‚Äù ‚Üí escribir historial ‚Üí exportar a Spotify) requieren consistencia y manejo de errores sin transacciones distribuidas.

**Alternativas**  
- A) Transacciones distribuidas 2PC (complejidad alta, fr√°gil).  
- B) Gesti√≥n ad-hoc de reintentos por servicio (inconsistente, dif√≠cil de mantener).  
- C) **Patr√≥n Saga** con pasos y compensaciones; **outbox** para publicar eventos confiables; **idempotencia** para evitar duplicados.

**Criterios de Elecci√≥n**  
- Consistencia eventual aceptable.  
- Trazabilidad y facilidad de recuperaci√≥n.  
- Evitar dobles cobros/duplicados.

**Decisi√≥n**  
- **C) Implementar Sagas orquestadas por servicio iniciador**, con **outbox** para emitir eventos de forma at√≥mica con la escritura local y **idempotency-key** en operaciones sensibles (pagos, exportaciones, sincronizaciones).

**Sustento**  
- Provee pasos claros, compensaciones (rollback l√≥gico) y reintentos seguros.  
- Evita duplicados y mantiene coherencia entre m√≥dulos sin bloquear a la UI.

---

### Decisi√≥n 3:

**T√≠tulo**  
- Propagaci√≥n de identidad y contexto com√∫n entre servicios

**Contexto**  
- Los m√≥dulos necesitan coordinar aplicando pol√≠tica de plan (Free/Premium), consentimiento vigente, preferencias y trazabilidad de cada acci√≥n del usuario.

**Alternativas**  
- A) Cada servicio define sus propios metadatos (riesgo de inconsistencias).  
- B) Trasladar todo el contexto en el cuerpo de cada petici√≥n (pesado y propenso a errores).  
- C) **Est√°ndar de encabezados y claims m√≠nimos** compartidos en todas las llamadas.

**Criterios de Elecci√≥n**  
- Simplicidad y uniformidad.  
- Cumplimiento de privacidad/consentimientos.  
- Observabilidad extremo a extremo.

**Decisi√≥n**  
- **C) Definir un contrato de coordinaci√≥n con metadatos obligatorios** en cada llamada entre servicios:  
  - `X-Request-Id` (trazabilidad), `X-User-Id`, `X-Session-Id`  
  - `X-Plan` (Free/Premium)  
  - `X-Consent-Version` (versi√≥n de consentimiento aplicada)  
  - `X-Correlation-Id` (para encadenar pasos de un mismo flujo)  
  - Tokens con **claims m√≠nimos** (id, plan, scopes) y verificaci√≥n de permisos en el borde.

**Sustento**  
- Asegura decisiones consistentes (l√≠mite de plan, privacidad) en todos los m√≥dulos.  
- Facilita auditor√≠a y diagn√≥stico al correlacionar eventos de extremo a extremo.

---

[‚¨ÖÔ∏è Anterior](../4.6.4/4.6.4.md) | [üè† Home](../../../README.md)