> [4. Decisiones Iniciales de Arquitectura](../4.md) ‚Ä∫ [4.4. M√≥dulo Gesti√≥n de Preferencias de Usuario / Ana Meza](4.4.md)

# 4.4. Gesti√≥n de Preferencias de Usuario / Ana Meza

### Decisiones de Asignaci√≥n de Responsabilidades

### Decisi√≥n 1:

**T√≠tulo**
- Separaci√≥n del m√≥dulo de Preferencias como microservicio independiente (Preferences Service)

**Contexto**
- Las preferencias (tema, idioma, notificaciones opt-in/out, calidad de reproducci√≥n, layouts, accesibilidad, etc.) requieren baja latencia de lectura, versionado y trazabilidad por usuario y por dispositivo.

- Mezclarlas con perfil o autenticaci√≥n dificulta el escalamiento y la evoluci√≥n de esquemas sin afectar dominios cr√≠ticos.

**Alternativas**
- Incluir preferencias dentro de User Profile Service.

- Persistir preferencias en el cliente y sincronizarlas de forma best-effort.

**Criterios de Elecci√≥n**
- Aislamiento de cambios de esquema sin impactar otros dominios.

- Escalabilidad de lecturas (read-heavy) y cach√© espec√≠fica.

- Auditor√≠a (historial de cambios) y reversi√≥n (rollbacks) por usuario/dispositivo.

**Decisi√≥n**
- **Crear un microservicio Preferences Service con su propio datastore y API, responsable de CRUD, versionado y auditor√≠a de preferencias.**

**Sustento**
- Reduce el acoplamiento con Perfil y Auth, permite escalar lecturas con cach√© y soporta evoluci√≥n r√°pida de claves/valores y estructuras anidadas sin riesgo al resto del sistema.

--

### Decisi√≥n 2:

**T√≠tulo**
- Modelo de datos h√≠brido: key-value tipado + esquema normalizado para preferencias sensibles

**Contexto**
- La mayor√≠a de preferencias son simples (key-value) y cambian con frecuencia; otras (p. ej., consentimientos de tracking por categor√≠a) requieren integridad, referencialidad y cumplimiento normativo.

**Alternativas**
- Todo key-value en documento.

- Todo relacional normalizado.

- Enfoque h√≠brido: documento key-value tipado para ajustes generales + tablas normalizadas para √°mbitos regulados.

**Criterios de Elecci√≥n**
- Flexibilidad para nuevas claves sin migraciones costosas.
- Garant√≠as de integridad y auditor√≠a para preferencias reguladas.
- Rendimiento en lecturas masivas y filtros por √°mbito.

**Decisi√≥n**
- **Usar almacenamiento documental (p. ej., JSON) para claves generales con tipado y validaci√≥n de esquema; y tablas relacionales para consentimientos y flags sujetos a normativa.**

**Sustento**
- Permite velocidad de cambio donde importa (UI/UX) y control estricto donde se exige (privacidad, auditor√≠a).

---

### Decisi√≥n 3:

**T√≠tulo**
- Jerarqu√≠a y reglas de resoluci√≥n de preferencias (global, app, tenant, usuario, dispositivo)

**Contexto**
- Un usuario puede tener m√∫ltiples dispositivos y pertenecer a distintos tenants/espacios. Las preferencias se aplican por √°mbito y deben resolverse determin√≠sticamente.

**Alternativas**
- Solo nivel usuario.
- Solo nivel dispositivo.
- Jerarqu√≠a con herencia y precedencia configurables.

**Criterios de Elecci√≥n**
- Experiencia consistente entre dispositivos con posibilidad de overrides locales.
- Simplicidad para el cliente (SDK) y trazabilidad del valor efectivo.
- Idempotencia y reproducibilidad ante auditor√≠a.

**Decisi√≥n**
- **Definir jerarqu√≠a de resoluci√≥n: default global ‚Üí app ‚Üí tenant/espacio ‚Üí usuario ‚Üí dispositivo. El valor efectivo y su fuente se devuelven en cada respuesta.**

**Sustento**
- Evita ambig√ºedades, facilita depuraci√≥n y permite pol√≠ticas corporativas por tenant sin bloquear preferencias personales.

---

### Decisiones de Modelo de Datos
### Decisi√≥n 1:
**T√≠tulo**
- Modelo h√≠brido para preferencias: Key-Value tipado + entidades normalizadas para √°mbitos regulados

**Contexto**
- La mayor√≠a de preferencias son configuraciones simples (tema, idioma, accesibilidad, layouts) que cambian con alta frecuencia.

**Alternativas**
- Todo en tabla relacional normalizada.
- Todo en documento/NoSQL (KV sin esquema).
- Enfoque h√≠brido con JSONB para claves gen√©ricas y tablas relacionales para √°mbitos regulados.

**Criterios de Elecci√≥n**
- Flexibilidad de esquema y evoluci√≥n sin migraciones costosas.
- Integridad y auditor√≠a donde lo exige la normativa.
- Performance en lecturas masivas con filtros por usuario/√°mbito.

**Decisi√≥n**
- **Usar user_preferences (JSONB con tipado/validaci√≥n de esquema) para claves generales y regulated_preferences (relacional) para consentimientos/flags sujetos a cumplimiento**

**Sustento**
- Permite velocidad de cambio en UI/UX, manteniendo control estricto y trazable en datos sensibles.

### Decisi√≥n 2:
**T√≠tulo**
- Esquema de resoluci√≥n jer√°rquica y llave compuesta para escopos

**Contexto**
- Las preferencias se aplican por jerarqu√≠a: global ‚Üí app ‚Üí tenant ‚Üí usuario ‚Üí dispositivo.
- Se necesita determinismo e inspecci√≥n del ‚Äúvalor efectivo‚Äù y su fuente.

**Alternativas**
- Resolver solo a nivel usuario.
- Duplicar valores por cada √°mbito.
- Modelo con overrides por √°mbito y resoluci√≥n determin√≠stica.

**Criterios de Elecci√≥n**
- Simplicidad para el cliente y reproducibilidad.
- Consultas r√°pidas por usuario/√°mbito/clave.
- Evitar ambig√ºedades y condiciones de carrera.

**Decisi√≥n**
- **Definir llave compuesta (user_id, scope_type, scope_id, pref_key) con columna effective_value calculada en lectura y source_scope retornado en API.**

**Sustento**
- Facilita depuraci√≥n, reduce duplicidad y garantiza consistencia entre dispositivos/tenants.

---

### Decisiones de Elecci√≥n de Tecnolog√≠a
### Decisi√≥n 1:
**T√≠tulo**
- Backend con NestJS (Node.js + TypeScript) y validaci√≥n de esquema

**Contexto**
- El servicio es read-heavy, requiere validaciones consistentes y contratos claros entre clientes.
- Se busca modularidad, inyecci√≥n de dependencias y pipes de validaci√≥n.

**Alternativas**
- Express ‚Äúbare‚Äù.
- Spring Boot (Java).
- NestJS con class-validator/zod para DTOs.

**Criterios de Elecci√≥n**
- Productividad y patr√≥n de m√≥dulos.
- Pruebas unitarias/e2e integradas.
- ETipado fuerte y DX consistente.

**Decisi√≥n**
- **Adoptar NestJS + TypeScript con DTOs validados (Zod o class-validator) y OpenAPI autogenerado.**

**Sustento**
- Acelera el desarrollo, estandariza controladores/guards y facilita contratos API bien definidos.

### Decisi√≥n 2:
**T√≠tulo**
- PostgreSQL como datastore principal con JSONB + √≠ndices GIN

**Contexto**
- Se requieren relaciones (usuarios, tenants), transacciones y campos flexibles para preferencias.

**Alternativas**
- MongoDB (documental puro).
- MySQL
- PostgreSQL con JSONB.

**Criterios de Elecci√≥n**
- ACID, integridad referencial y JSONB nativo.
- √çndices eficientes (BTREE/GIN compuestos).
- Operadores JSON y consultas mixtas.

**Decisi√≥n**
- **Usar PostgreSQL; user_preferences con JSONB e √≠ndice GIN por pref_key y filtros por (user_id, scope); entidades reguladas relacionales.**

**Sustento**
- Combina consistencia y flexibilidad, optimizando las consultas frecuentes del m√≥dulo.

### Decisi√≥n 3:
**T√≠tulo**
- Redis para cach√© + Pub/Sub de invalidaci√≥n; bus de eventos para propagaci√≥n

**Contexto**
- La UI lee preferencias en cada carga; cambios deben reflejarse casi en tiempo real.
- Otros servicios (Notificaciones, Recomendador) dependen de se√±ales de preferencias

**Alternativas**
- Solo DB sin cach√©
- Cach√© cliente √∫nicamente
- Cach√© servidor + invalidaci√≥n por eventos y outbox pattern

**Criterios de Elecci√≥n**
- Latencia P95 baja.
- Consistencia eventual controlada.
- Desacoplamiento entre productores/consumidores.

**Decisi√≥n**
- **Cach√© Redis (TTL corto) con invalidaci√≥n por canal Pub/Sub; emisi√≥n de preference.changed al bus (Kafka/NATS) usando Transactional Outbox.**

**Sustento**
- Reduce latencia de lectura y asegura propagaci√≥n fiable sin acoplar servicios.
---

### Decisiones de Tiempo de Enlace
### Decisi√≥n 1:
**T√≠tulo**  
- Cat√°logo de claves y reglas de resoluci√≥n cargado en build con hot reload opcional

**Contexto**  
- Las claves de preferencias y sus metadatos (tipo, default, rango, validadores) conforman un cat√°logo.  
- Se requieren cambios operativos sin forzar redeploy completo, manteniendo trazabilidad por versi√≥n.

**Alternativas**  
- Cat√°logo hard-coded en el binario.  
- Carga √∫nicamente en tiempo de ejecuci√≥n desde un servicio de configuraci√≥n.  
- Enfoque mixto: snapshot en build + recarga controlada en runtime.

**Criterios de Elecci√≥n**  
- Estabilidad y reproducibilidad por versi√≥n.  
- Flexibilidad para ajustes operativos.  
- Auditor√≠a de cambios y rollbacks simples.

**Decisi√≥n**  
- **Empaquetar un snapshot del cat√°logo en la imagen (build) y habilitar recarga en runtime desde Config Service/Blob firmado, activable por feature flag.**

**Sustento**  
- Garantiza consistencia entre entornos y permite ajustes sin reconstruir la imagen cuando sea necesario.  
---

### Decisi√≥n 2:
**T√≠tulo**  
- Enlace din√°mico de integraciones opcionales mediante variables de entorno/gestor de secretos

**Contexto**  
- Integraciones (p. ej., recomendador, marketing) consumen se√±ales de preferencias pero no est√°n presentes en todos los entornos.  
- Credenciales y endpoints cambian y no deben versionarse en c√≥digo.

**Alternativas**  
- Compilar variantes por entorno.  
- Enlazar todas las integraciones siempre.  
- Cargar conectores a demanda en tiempo de ejecuci√≥n.

**Criterios de Elecci√≥n**  
- Seguridad de secretos.  
- Flexibilidad y zero-downtime.  
- Menor huella en dev/test.

**Decisi√≥n**  
- **Resolver endpoints/credenciales v√≠a variables de entorno o Vault; inicializar conectores solo si `INTEGRATION_* = enabled`.**

**Sustento**  
- Evita builds por entorno, reduce costos y riesgos al no cargar componentes innecesarios.  
---

### Decisi√≥n 3:
**T√≠tulo**  
- Enlace diferido para consumidores de eventos (Analytics/ML) y guards de degradaci√≥n

**Contexto**  
- La operaci√≥n base de preferencias no debe depender del bus/eventos.  
- La publicaci√≥n de eventos no puede bloquear escrituras.

**Alternativas**  
- Publicar sincr√≥nicamente y fallar si el bus no responde.  
- Colas internas con reintentos y dead-letter.  
- Ejecutar todo sincr√≥nico sin fallbacks.

**Criterios de Elecci√≥n**  
- Resiliencia ante fallas externas.  
- Garant√≠a de entrega al menos una vez.  
- Impacto m√≠nimo en la latencia de escritura.

**Decisi√≥n**  
- **Usar Transactional Outbox + worker as√≠ncrono con reintentos y DLQ; circuit breaker para degradar a ‚Äúsolo DB + cach√©‚Äù si el bus falla.**

**Sustento**  
- A√≠sla el CRUD cr√≠tico de dependencias no esenciales y mantiene SLAs aun con ca√≠das del pipeline de eventos.  

---

[‚¨ÖÔ∏è Anterior](../4.3/4.3.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../4.5/4.5.md)