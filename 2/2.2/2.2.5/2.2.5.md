# 2.2.5. Módulo 5

## Integración con Plataformas Externas / Andrew Tamayo

### Contexto

Los atributos de calidad para la integración con plataformas externas se enfocan en **interoperabilidad**, **confiabilidad**, **rendimiento** y **seguridad**. Este módulo es crítico ya que la experiencia del usuario depende de la correcta comunicación con APIs de servicios de streaming como Spotify, y futuras integraciones con Apple Music y YouTube Music.

Se definieron 6 escenarios principales que abordan la estabilidad de las conexiones, manejo de errores, límites de tasa, autenticación segura y compatibilidad multi-plataforma.

### Escenarios

**ESCENARIO 1: Rate Limiting y Recuperación Automática**

**Atributo de Calidad:** Confiabilidad y Rendimiento

**Condición Inicial:** El sistema está creando múltiples playlists y realizando llamadas frecuentes a la API de Spotify.

**Acción:**
1. El sistema supera el límite de 100 requests por minuto establecido por Spotify.
2. La API responde con HTTP 429 (Too Many Requests) con header `Retry-After`.
3. El sistema implementa backoff exponencial: espera inicial de 1s, luego 2s, 4s.

**Resultado Esperado:**
- El sistema debe pausar automáticamente las requests y respetar el tiempo de `Retry-After`.
- Después de máximo 3 reintentos, debe notificar al usuario sin crashear la aplicación.
- La cola de requests pendientes debe procesarse correctamente una vez restablecida la conexión.

---

**ESCENARIO 2: Manejo de Tokens Expirados**

**Atributo de Calidad:** Seguridad y Confiabilidad

**Condición Inicial:** El usuario tiene una sesión activa pero el access token de Spotify ha expirado (1 hora).

**Acción:**
1. El usuario intenta crear una nueva playlist.
2. La API responde con HTTP 401 (Unauthorized).
3. El sistema detecta la expiración e intenta renovar usando el refresh token.

**Resultado Esperado:**
- El refresh debe completarse en menos de 2 segundos sin intervención del usuario.
- Si el refresh token también es inválido, debe solicitar reautorización manteniendo el contexto actual.
- No debe perderse la playlist generada durante el proceso de renovación.

---

**ESCENARIO 3: Disponibilidad de Servicios Externos**

**Atributo de Calidad:** Confiabilidad y Disponibilidad

**Condición Inicial:** El usuario genera una playlist cuando la API de Spotify está experimentando problemas (HTTP 5xx).

**Acción:**
1. El sistema intenta crear la playlist pero recibe errores del servidor de Spotify.
2. Después de 3 intentos fallidos, la operación se considera temporalmente no disponible.

**Resultado Esperado:**
- El sistema debe guardar localmente la playlist generada como "pendiente de sincronización".
- Debe mostrar un mensaje claro: "Spotify no disponible. Tu playlist se guardará cuando se restablezca la conexión".
- Implementar reintentos automáticos en background cada 5 minutos hasta sincronizar exitosamente.

---

**ESCENARIO 4: Compatibilidad Multi-Plataforma**

**Atributo de Calidad:** Interoperabilidad y Mantenibilidad

**Condición Inicial:** El sistema debe soportar tanto Spotify como Apple Music con la misma funcionalidad.

**Acción:**
1. El usuario cambia su servicio preferido de Spotify a Apple Music en configuraciones.
2. Intenta crear una nueva playlist con la misma emoción detectada anteriormente.

**Resultado Esperado:**
- La interfaz común debe mapear correctamente los features musicales entre plataformas.
- La playlist debe crearse con características similares independientemente de la plataforma.
- Los tests de contrato deben validar que ambas implementaciones cumplen la misma interfaz.

---

**ESCENARIO 5: Seguridad en el Almacenamiento de Credenciales**

**Atributo de Calidad:** Seguridad y Privacidad

**Condición Inicial:** El usuario autoriza la conexión con Spotify y el sistema debe almacenar los tokens de forma segura.

**Acción:**
1. Se completa el flujo OAuth y se obtienen access y refresh tokens.
2. Los tokens deben almacenarse en el dispositivo del usuario.

**Resultado Esperado:**
- Los tokens deben cifrarse usando AES-256 antes del almacenamiento local.
- No debe ser posible extraer tokens en texto plano desde la aplicación.
- Los tokens deben eliminarse automáticamente al desconectar la cuenta o desinstalar la app.

---

**ESCENARIO 6: Sincronización de Cambios en Tiempo Real**

**Atributo de Calidad:** Rendimiento y Consistencia

**Condición Inicial:** El usuario edita una playlist en LYRA (reordena canciones, elimina tracks).

**Acción:**
1. El usuario hace cambios locales y presiona "Sincronizar con Spotify".
2. El sistema debe aplicar solo las diferencias (delta) en lugar de recrear toda la playlist.

**Resultado Esperado:**
- La sincronización debe completarse en menos de 5 segundos para playlists de hasta 50 canciones.
- Solo se deben enviar las operaciones necesarias (agregar/remover/reordenar específicas).
- Si falla la sincronización parcial, debe revertir cambios y notificar qué operaciones fallaron.
