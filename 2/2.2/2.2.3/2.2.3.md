# 2.2.3. Módulo 3

## Gestión de Planes y Suscripciones / Leonardo Salazar

**Contexto**

El módulo de **Gestión de Planes y Suscripciones** es responsable de administrar los planes de pago, la facturación y la seguridad de las transacciones de los usuarios premium.  

Las operaciones incluyen el manejo de datos financieros, la comunicación con pasarelas de pago externas, la visualización de historiales de suscripción y la integración con sistemas analíticos y de marketing.


---

### ESCENARIO 1: Prevención de Inyección SQL en el Endpoint de Pago

**ID:** ESCP-21  
**Atributo de Calidad:** Seguridad  
**Stakeholder:** STK-02 (CTO)

**Condición Inicial:**  
El sistema recibe solicitudes al endpoint de confirmación de pago desde múltiples usuarios premium.

**Acción:**  
Un atacante intenta manipular el parámetro del identificador de pago con código SQL malicioso.  
El backend recibe la solicitud e identifica patrones sospechosos.

**Resultado Esperado:**  
- El sistema debe validar y sanear todas las entradas, evitando ejecución de código malicioso.  
- Las peticiones maliciosas deben ser rechazadas con código HTTP 400 o 403.  
- Debe generarse un registro de intento de inyección en los logs de seguridad.

---

### ESCENARIO 2: Protección en el Almacenamiento de Tokens de Pago

**ID:** ESCP-22  
**Atributo de Calidad:** Seguridad  
**Stakeholder:** STK-04 (Desarrollador Backend)

**Condición Inicial:**  
El sistema almacena temporalmente tokens generados por la pasarela de pago.

**Acción:**  
Se detecta un posible acceso no autorizado al almacenamiento interno.  
El sistema revisa la validez de los tokens y sus políticas de expiración.

**Resultado Esperado:**  
- Los tokens deben almacenarse cifrados con AES-256 y tener expiración automática tras cada transacción.  
- No deben quedar accesibles en memoria ni en texto plano.  
- El sistema debe invalidar y regenerar los tokens comprometidos automáticamente.

---

### ESCENARIO 3: Cifrado de Datos Sensibles en la Base de Datos

**ID:** ESCP-23  
**Atributo de Calidad:** Seguridad  
**Stakeholder:** STK-11 (Administrador de Base de Datos)

**Condición Inicial:**  
El servidor de base de datos contiene información de transacciones y credenciales cifradas.

**Acción:**  
Un atacante logra acceso parcial al servidor mediante vulnerabilidad del sistema operativo.  
Intenta leer directamente los datos almacenados en la base.

**Resultado Esperado:**  
- Los datos sensibles deben estar cifrados en reposo con claves rotativas periódicamente (cada 90 días).  
- El atacante no debe poder obtener datos legibles.  
- Debe notificarse el intento de acceso no autorizado al panel de auditoría.

---

### ESCENARIO 4: Pruebas Seguras en Entorno Sandbox

**ID:** ESCP-24  
**Atributo de Calidad:** Testability  
**Stakeholder:** STK-07 (QA / Tester)

**Condición Inicial:**  
El equipo de QA necesita validar flujos de pago sin usar datos financieros reales.

**Acción:**  
El tester ejecuta pruebas de compra y renovación en un entorno controlado.  
El sistema usa datos simulados provistos por la pasarela sandbox.

**Resultado Esperado:**  
- El sistema debe ofrecer un entorno sandbox aislado para pruebas seguras.  
- No debe enviar transacciones reales ni afectar cuentas productivas.  
- Los logs deben distinguir pruebas sandbox de operaciones reales.

---

### ESCENARIO 5: Visualización Clara del Historial de Suscripciones

**ID:** ESCP-25  
**Atributo de Calidad:** Usabilidad  
**Stakeholder:** STK-06 (Diseñador UX/UI)

**Condición Inicial:**  
El usuario premium desea revisar su historial de pagos y el estado actual de su suscripción.

**Acción:**  
Accede a la sección “Mi suscripción”.  
El sistema recupera los datos históricos de pago y sus estados.

**Resultado Esperado:**  
- La interfaz debe mostrar la información de forma clara, con fechas y estados visibles.  
- Deben incluirse iconos o etiquetas que indiquen pagos exitosos, pendientes o rechazados.  
- La carga de datos debe completarse en menos de 2 segundos, sin errores visuales.

---

### ESCENARIO 6: Diagnóstico Rápido ante Cobros Duplicados

**ID:** ESCP-26  
**Atributo de Calidad:** Mantenibilidad  
**Stakeholder:** STK-08 (Soporte Técnico)

**Condición Inicial:**  
Un usuario reporta un doble cobro en su cuenta.

**Acción:**  
El soporte accede al panel de transacciones históricas.  
El sistema muestra los logs y trazas completas de cada operación de pago.

**Resultado Esperado:**  
- El soporte debe poder revisar registros detallados para identificar el error.  
- El tiempo de diagnóstico debe ser menor a 24 horas.  
- El sistema debe permitir revertir o reembolsar transacciones duplicadas.

---

### ESCENARIO 7: Escalado ante Incremento Masivo de Suscripciones

**ID:** ESCP-27  
**Atributo de Calidad:** Escalabilidad  
**Stakeholder:** STK-10 (Arquitecto de Software)

**Condición Inicial:**  
Se lanza una promoción especial que incrementa en un 300% las suscripciones simultáneas.

**Acción:**  
El sistema recibe múltiples solicitudes concurrentes de registro premium.  
Los microservicios de pago y validación procesan las peticiones.

**Resultado Esperado:**  
- El sistema debe escalar horizontalmente sin degradar el tiempo de respuesta (> 2 s).  
- Los balanceadores deben redistribuir la carga entre instancias disponibles.  
- No debe registrarse pérdida de transacciones ni caídas del servicio.

---

### ESCENARIO 8: Anonimización de Datos para Análisis Financiero

**ID:** ESCP-28  
**Atributo de Calidad:** Seguridad  
**Stakeholder:** STK-12 (Analista de Datos)

**Condición Inicial:**  
El analista solicita información sobre comportamiento de usuarios premium para análisis financiero.

**Acción:**  
El sistema prepara un dataset exportable con información agregada.  
Se ejecuta el proceso de anonimización de datos personales.

**Resultado Esperado:**  
- Los datos deben anonimizarse antes de ser exportados o compartidos.  
- Ningún identificador personal (correo, nombre, tarjeta) debe ser accesible.  
- El dataset debe cumplir los lineamientos del GDPR y PCI-DSS.

---

### ESCENARIO 9: Integración Segura con CRM Externo

**ID:** ESCP-29  
**Atributo de Calidad:** Interoperabilidad  
**Stakeholder:** STK-14 (Especialista en Marketing Digital)

**Condición Inicial:**  
El sistema de suscripciones necesita enviar datos a una plataforma CRM para campañas personalizadas.

**Acción:**  
El CRM realiza solicitudes a la API interna de suscripciones.  
El sistema expone endpoints REST protegidos mediante API Keys y OAuth 2.0.

**Resultado Esperado:**  
- La API debe proveer endpoints seguros y compatibles con estándares REST.  
- Toda la comunicación debe realizarse sobre HTTPS/TLS 1.3.  
- Los tokens de acceso deben tener expiración y registro de auditoría.

---

### ESCENARIO 10: Transmisión Segura de Datos de Tarjeta

**ID:** ESCP-30  
**Atributo de Calidad:** Seguridad  
**Stakeholder:** USR-02 (Usuario Premium)

**Condición Inicial:**  
El usuario ingresa los datos de su tarjeta en el formulario de pago dentro de la app.

**Acción:**  
El sistema captura los datos y los envía a la pasarela de pago externa.  
La pasarela procesa la transacción y retorna un token temporal.

**Resultado Esperado:**  
- Los datos deben transmitirse cifrados (HTTPS/TLS) y nunca almacenarse en servidores propios.  
- El sistema solo debe conservar el token temporal necesario para confirmar la transacción.  
- El usuario debe visualizar un mensaje de confirmación clara y segura (“Pago procesado exitosamente”).
