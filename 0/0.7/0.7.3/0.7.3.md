> [0. Acerca del Grupo](../../0.md) ‚Ä∫ [0.7. Trabajo Individual (Patrones Cloud)](../0.7.md) ‚Ä∫ [0.7.3. Integrante 3](0.7.3.md)

# 0.7.3. Leonardo Salazar

# Desarrollo del patr√≥n: Disyuntor (circuit breaker)

### Problema

En sistemas distribuidos o basados en microservicios, uno de los principales desaf√≠os es manejar las fallas intermitentes o ca√≠das temporales de servicios externos, como APIs de terceros, bases de datos o pasarelas de pago.  
Cuando un servicio externo deja de responder, las aplicaciones suelen seguir enviando solicitudes en bucle, lo que consume recursos innecesariamente, genera bloqueos, aumenta la latencia y puede provocar una ca√≠da en cascada del sistema.


---

### Soluci√≥n

El patr√≥n **disyuntor (circuit breaker)** propone un mecanismo que supervisa las llamadas a servicios externos y abre el circuito cuando detecta un n√∫mero determinado de fallos consecutivos.  
Al abrirse, el sistema bloquea temporalmente las nuevas solicitudes hacia el servicio fallido y devuelve una respuesta controlada o fallback.

Despu√©s de un tiempo preconfigurado, el circuito entra en modo semiabierto y permite una llamada de prueba:  
- Si la llamada tiene √©xito, el circuito vuelve a cerrarse.  
- Si falla, se mantiene abierto por otro intervalo.

De esta manera:
- Se evita la sobrecarga del servicio externo.  
- Se protege la estabilidad interna del sistema.  
- Se mantiene la experiencia del usuario con respuestas predecibles y seguras.

---

### Casos de Aplicaci√≥n

**Aplicaciones Fintech o E-commerce:**  
Plataformas que procesan pagos con servicios externos (Stripe, PayPal, MercadoPago) usan disyuntores para evitar que la ca√≠da de la pasarela afecte toda la aplicaci√≥n.

**Sistemas de reservas o boletaje:**  
Cuando una API de terceros (aerol√≠nea, hotel) est√° fuera de servicio, el disyuntor permite mostrar un mensaje al usuario sin detener el resto del sistema.

**Startups SaaS con microservicios:**  
En entornos donde varios microservicios dependen entre s√≠ (facturaci√≥n, usuarios, notificaciones), el disyuntor evita que un servicio lento bloquee a los dem√°s.

**Plataformas de streaming o contenido bajo demanda:**  
Si el servicio de recomendaci√≥n o cat√°logo falla, el disyuntor devuelve una lista temporal o en cach√©, manteniendo la operatividad parcial sin afectar la experiencia del usuario.

---

### Aplicaci√≥n en el proyecto grupal

En el proyecto **Lyra**, dentro del **m√≥dulo de gesti√≥n de planes y suscripciones**, el patr√≥n Disyuntor se implementar√° para **proteger las llamadas hacia la pasarela de pagos Stripe**.

**Flujo del proceso:**
1. El usuario premium ingresa sus datos de pago en un entorno seguro (*Stripe.js*), donde los datos son tokenizados cumpliendo el est√°ndar **PCI-DSS**.  
2. El backend recibe el token y lo env√≠a a Stripe a trav√©s de un m√©todo protegido por el disyuntor.  
3. Si Stripe responde correctamente, el pago se confirma y se actualiza el estado de la suscripci√≥n.  
4. Si Stripe no responde o arroja errores repetidos, el circuito se abre, evitando nuevos intentos por un tiempo definido (por ejemplo, 30 segundos).  
5. Durante ese tiempo, el sistema muestra un mensaje controlado al usuario:

> ‚ÄúEl servicio de pagos no est√° disponible temporalmente. Por favor, int√©ntalo m√°s tarde.‚Äù

6. Los **logs del disyuntor** registran el incidente, permitiendo un diagn√≥stico r√°pido por parte del equipo de soporte t√©cnico.

# Consideraciones t√©cnicas

### 1. Requisitos

Tener instalado Docker y Docker Compose. Se puede descargar a traves de este [link](https://www.docker.com/products/docker-desktop/) con la opcion "Download Docker Desktop" y seguir la condiguraci√≥n default

![Paso 1 Docker](Docker1.png)

Todos los servicios se levantan de manera autom√°tica y consistente gracias a Docker Compose, sin necesidad de instalaciones extras.

Ademas de crearte una cuenta en [Stripe](https://stripe.com/es)

![Paso 1 Stripe](Stripe1.png)

Una vez creada tu cuenta, te tendrias que dirigir al buscador y colocar "claves de API" y darle a la opcion "Desarrolladores - Claves de API"

![Paso 2 Stripe](Stripe2.png)

Una vez ahi, tener a la mano la clave secreta y publica que se encuentran en estas pantallas para integrarlas en la implementaci√≥n

## 2. Configuraci√≥n

Clonar el repositorio del proyecto:

```bash
git clone https://github.com/ulima-arqsoft/arqui252-grupo5.git
```

y luego entrar en la carpeta donde se encuentra el proyecto con:

```bash
cd 0\0.7\0.7.3\circuit-breaker-demo
```

Por ultimo, se tendran que crear 2 archivos **.env**

El primero debe ir dentro de la carpeta backend y debe tener sin las "":

```bash
STRIPE_SECRET_KEY="COLOCAR TU PROPIA CLAVE SECRETA DE STRIPE"
```
El segundo debe ir dentro de la carpeta frontend y debe tener sin las "":

```bash
REACT_APP_STRIPE_PUBLIC_KEY="COLOCAR TU PROPIA CLAVE PUBLICA DE STRIPE"
REACT_APP_API_URL=http://localhost:3000
```
## 3. Ejecuci√≥n

Desde la carpeta ra√≠z del m√≥dulo, ejecutar:

```bash
docker-compose up
```

Esto iniciar√° autom√°ticamente los siguientes servicios:

- ‚öôÔ∏è **Backend** (puerto `3000`)  
- üíª **Frontend** (puerto `3001`)  

La ejecuci√≥n puede visualizarse en **Docker Desktop**

![Docker Ver 1](Docker2.png)

Seleccionando el contenedor circuit-breaker-demo se podra apreciar que todos los servicios se encuentran activos y en ejecuci√≥n.

![Docker Ver 2](Docker3.png)

---

## 4. Preparaci√≥n para pruebas

Tener abierto en el navegador: 

- [http://localhost:3001](http://localhost:3001) para tener el frontend
- Docker desktop abierto en la siguiente pantalla

![Docker Ver 3](Docker3.png)

---

## 5. Pruebas de circuit-breaker

### Funcionamiento normal

Para probar el circuit breaker, primeramente se vera como funciona normalmente la demo.

Para ello nos colocamos en el frontend y rellenamos los campos del metodo de pago con estos datos de prueba de la documentaci√≥n de stripe:

- numero de tarjeta: 4242 4242 4242 4242

- fecha de vencimiento: Cualquier fecha futura como (11/30)

- CVC: 3 digitos cualquiera como (567)

Le damos al boton de "pagar ahora"

Y saldra un aviso que mostrara que que el pago se ha procesado exitosamente

![frontend 1](front1.png)

### Circuit breaker en acci√≥n

Para probar el circuit breaker se necesitara desconectarse de internet y darle al boton de "pagar ahora"

![frontend 2](front2.png)

Ahora te aparecera "Servicio de pagos no disponible - Simulacion activada"
Ahora viendo el panel de la derecha de la pantalla de docker desktop te ap√°recera el estado en el que se encuentra el sistema y como el circuit breaker se pone en modo OPEN y luego intenta restaurar la conexion  periodicamente (Half Open), si se vuelve a dar el boton de "pagar ahora" volvera a realizar el proceso hasta que se restaure por completo (Closed)

![docker dash](dockerDash.png)

Aqui una tabla comparativa en caso se estuviera con un circuit breaker y no se estuviera con circuit breaker:

| **Situaci√≥n** | **Sin Circuit Breaker** | **Con Circuit Breaker** |
|----------------|--------------------------|--------------------------|
| **Stripe responde lento** | El backend se congela esperando. | Se corta a los 5 s y devuelve un error controlado. |
| **Stripe cae** | El backend sigue intentando y saturando hilos. | Se abre el circuito y bloquea temporalmente. |
| **Stripe se recupera** | Se recupera lentamente. | Se detecta en el pr√≥ximo intento ‚Äúhalf-open‚Äù. |
---

[‚¨ÖÔ∏è Anterior](../0.7.2/0.7.2.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../0.7.4/0.7.4.md)