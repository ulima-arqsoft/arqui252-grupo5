> [6. Documentaci√≥n de Arquitectura (Bosquejo)](../6.md) ‚Ä∫ [6.3. Diagrama de Componentes](6.3.md)

# 6.3. Diagrama de Componentes

El siguiente diagrama representa la **arquitectura interna a nivel de componentes** del sistema LYRA, mostrando c√≥mo se estructuran los diferentes m√≥dulos y sus interacciones dentro de cada microservicio.

![Diagrama de Componentes](/6/6.3/componentes.png)

---

## Prop√≥sito del Diagrama de Componentes

Este diagrama muestra la **descomposici√≥n interna** de los principales contenedores identificados en el diagrama anterior.

---

## Componentes por M√≥dulo

### **Frontend Web Application**
- **Emotion Detection Component**
  - Camera Handler: Manejo de c√°mara y captura de selfies
  - TensorFlow.js Engine: Procesamiento local de emociones (on-device)
  - Manual Selector: Interfaz alternativa para selecci√≥n manual de emociones

- **UI Components**
  - Authentication UI: Formularios de login/registro
  - Playlist Viewer: Visualizaci√≥n y reproducci√≥n de playlists
  - User Preferences: Configuraci√≥n de g√©neros y preferencias
  - Subscription Manager: Gesti√≥n de planes y pagos

### **Authentication & User Management Service**
- **Auth Service**
  - OAuth Handler: Gesti√≥n de flujos OAuth (Google, Spotify, Apple)
  - JWT Token Manager: Emisi√≥n y validaci√≥n de tokens JWT
  - Session Controller: Manejo de sesiones activas

- **User Profile Service**
  - Profile Manager: Gesti√≥n de perfiles de usuario
  - Privacy Controller: Manejo de consentimientos y privacidad
  - History Tracker: Registro de actividad y historial

- **Notification Service**
  - Push Notifier: Notificaciones push m√≥viles
  - Email Sender: Env√≠o de correos (verificaci√≥n, 2FA)
  - Template Engine: Gesti√≥n de plantillas de mensajes

### **Playlist Generation Service**
- **Emotion Analysis Engine**
  - Emotion Classifier: Clasificaci√≥n de emociones detectadas
  - Mood Mapper: Mapeo de emociones a par√°metros musicales
  - Context Analyzer: An√°lisis de contexto temporal y preferencias

- **Recommendation Engine**
  - Feature Extractor: Extracci√≥n de features musicales (valence, energy, tempo)
  - Algorithm Controller: Algoritmos de recomendaci√≥n personalizados
  - Playlist Builder: Construcci√≥n y organizaci√≥n de playlists

### **External Platform Integration Service**
- **OAuth Service**
  - Provider Authenticator: Autenticaci√≥n espec√≠fica por proveedor
  - Token Rotator: Rotaci√≥n autom√°tica de tokens de acceso
  - Scope Manager: Gesti√≥n de permisos y scopes m√≠nimos

- **Platform Operations Service**
  - Spotify Adapter: Integraci√≥n espec√≠fica con Spotify Web API
  - Apple Music Adapter: Integraci√≥n con Apple Music API
  - YouTube Music Adapter: Integraci√≥n con YouTube Music API
  - Provider Factory: Factory pattern para crear adaptadores din√°micamente

- **Sync Manager**
  - Change Detector: Detecci√≥n de cambios en playlists locales/remotas
  - Conflict Resolver: Resoluci√≥n de conflictos de sincronizaci√≥n
  - Batch Processor: Procesamiento por lotes para optimizaci√≥n

### **Subscription & Billing Service**
- **Plan Manager**
  - Subscription Controller: Gesti√≥n de planes (Free/Premium)
  - Feature Gate: Control de acceso a funcionalidades por plan
  - Usage Tracker: Seguimiento de uso y l√≠mites

- **Payment Processor**
  - Gateway Integrator: Integraci√≥n con pasarelas de pago (Stripe, PayPal)
  - PCI Compliance Handler: Manejo seguro de datos de pago
  - Billing Engine: Generaci√≥n de facturas y comprobantes

### ‚öôÔ∏è **User Preferences Service**
- **Preference Manager**
  - Genre Controller: Gesti√≥n de g√©neros musicales favoritos
  - Settings Handler: Configuraci√≥n de duraci√≥n y estilo de playlists
  - Profile Customizer: Personalizaci√≥n de experiencia

- **Analytics Collector**
  - Behavior Tracker: Seguimiento de patrones de uso
  - Preference Learner: Aprendizaje autom√°tico de preferencias
  - Insight Generator: Generaci√≥n de insights personalizados

---

## üîÑ **Patrones de Interacci√≥n**

### **1. Flujo de Generaci√≥n de Playlist**
```
Emotion Detection ‚Üí Emotion Analysis Engine ‚Üí Recommendation Engine ‚Üí Platform Operations ‚Üí Sync Manager
```

### **2. Flujo de Autenticaci√≥n OAuth**
```
UI Components ‚Üí Auth Service ‚Üí OAuth Service ‚Üí Provider Authenticator ‚Üí Token Manager
```

### **3. Flujo de Sincronizaci√≥n**
```
Playlist Builder ‚Üí Sync Manager ‚Üí Platform Adapters ‚Üí Change Detector ‚Üí Conflict Resolver
```

### **4. Flujo de Suscripci√≥n**
```
Subscription Manager ‚Üí Plan Manager ‚Üí Payment Processor ‚Üí Gateway Integrator ‚Üí Billing Engine
```

---

## üõ°Ô∏è **Componentes Transversales**

### **Componentes de Seguridad**
- **API Gateway**: Control de tasa, autenticaci√≥n y autorizaci√≥n
- **Servicio de Cifrado**: Cifrado de tokens y datos sensibles
- **Registrador de Auditor√≠a**: Registro inmutable de operaciones cr√≠ticas

### **Componentes de Observabilidad**
- **Recolector de M√©tricas**: Recolecci√≥n de m√©tricas de rendimiento
- **Servicio de Verificaci√≥n de Salud**: Monitoreo de salud de componentes
- **Trazabilidad Distribuida**: Seguimiento de peticiones entre servicios

### **Componentes de Infraestructura**
- **Cache Redis**: Cache distribuido para tokens y metadatos
- **Cola de Mensajes**: Colas para procesamiento as√≠ncrono
- **Circuit Breaker**: Protecci√≥n contra fallos en cascada
- **Balanceador de Carga**: Distribuci√≥n de peticiones entre instancias

---

## üîß **Decisiones de Dise√±o Implementadas**

1. **Capa de Abstracci√≥n Independiente del Proveedor**: Implementada mediante `InterfazProveedorMusical` y adaptadores espec√≠ficos
2. **Separaci√≥n OAuth/Operaciones**: Auth Service separado de Platform Operations para mejor mantenibilidad
3. **Cache Multi-TTL**: Redis con diferentes TTL por tipo de dato (tokens: 1h, caracter√≠sticas: 7d, artistas: 30d)
4. **Circuit Breakers por Proveedor**: Aislamiento de fallos espec√≠ficos por plataforma externa
5. **Procesamiento en Dispositivo**: Emotion Detection Component ejecuta modelo localmente
6. **Sincronizaci√≥n Basada en Colas**: Sync Manager usa colas Redis para operaciones as√≠ncronas

---

## **Componentes de Infraestructura y Soporte**

### **Base de Datos**
- **PostgreSQL Principal**: Almacenamiento de usuarios, perfiles y preferencias
- **Redis Cache**: Cache de alta velocidad para tokens y metadatos musicales
- **Base de Datos de Auditor√≠a**: Almacenamiento inmutable de logs de seguridad

### **Servicios de Monitoreo**
- **Prometheus**: Recolecci√≥n de m√©tricas de sistema
- **Grafana**: Visualizaci√≥n de m√©tricas y alertas
- **ELK Stack**: Centralizaci√≥n y an√°lisis de logs

### **Servicios Externos Integrados**
- **Spotify Web API**: Proveedor principal de m√∫sica
- **Apple Music API**: Proveedor alternativo de m√∫sica  
- **YouTube Music API**: Proveedor adicional de m√∫sica
- **Stripe/PayPal**: Procesamiento de pagos
- **SendGrid**: Env√≠o de correos electr√≥nicos
- **Firebase**: Notificaciones push

---

## **M√©tricas y Monitoreo por Componente**

### **Frontend Components**
- Tiempo de detecci√≥n de emoci√≥n: < 500ms
- Tasa de √©xito de captura de imagen: > 95%
- Tiempo de carga de UI: < 2s

### **Authentication Service**
- Tiempo de autenticaci√≥n OAuth: < 3s
- Tasa de √©xito de login: > 99%
- Tiempo de validaci√≥n de token: < 50ms

### **Platform Integration Service**
- Tiempo de respuesta de APIs externas: < 1s
- Tasa de √©xito tras reintentos: > 99.5%
- Tiempo de sincronizaci√≥n: < 5s

### **Playlist Generation Service**
- Tiempo de generaci√≥n de recomendaciones: < 2s
- Precisi√≥n de mapeo emocional: > 85%
- Tiempo de construcci√≥n de playlist: < 3s

---

[‚¨ÖÔ∏è Anterior](../6.2/6.2.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../6.4/6.4.md)