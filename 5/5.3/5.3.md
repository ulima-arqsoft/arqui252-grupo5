> [5. T√°cticas](../5.md) ‚Ä∫ [5.3. M√≥dulo Gesti√≥n de Planes y Suscripciones / Leonardo Salazar](5.3.md)

# 5.3. M√≥dulo Gesti√≥n de Planes y Suscripciones / Leonardo Salazar

# Escenarios y Decisiones Arquitect√≥nicas ‚Äì M√≥dulo de Gesti√≥n de Planes y Suscripciones

---

## **Escenario 1 ‚Äì Seguridad en Datos de Pago**

Consideremos el siguiente escenario para **Gesti√≥n de Planes y Suscripciones**:

| COD Escenario | Fuente Est√≠mulo | Est√≠mulo | Artefacto | Entorno | Respuesta | Medida de Respuesta | Comentario |
|---------------|-----------------|-----------|------------|-----------|------------|----------------------|-------------|
| ESC-10 | Usuario premium | Ingreso de datos de pago para suscripci√≥n. | Gesti√≥n de Planes y Suscripciones | Entorno de transacci√≥n segura | Datos cifrados en tr√°nsito y reposo. | Cumplimiento PCI-DSS y 0 filtraciones. | El CTO y DBA deben garantizar seguridad y tokenizaci√≥n. |

---

# T√≠tulo
Elecci√≥n de t√°ctica de seguridad para garantizar la integridad y no repudio en transacciones de pago.



## Contexto
El m√≥dulo de Gesti√≥n de Planes y Suscripciones procesa transacciones cr√≠ticas. Aunque el cifrado en tr√°nsito (HTTPS/TLS) es un est√°ndar base, no protege contra ataques de manipulaci√≥n de datos (Man-in-the-Middle activo) donde el *payload* puede ser alterado antes de llegar al servidor, ni garantiza que la petici√≥n provenga de la aplicaci√≥n leg√≠tima.  
Para cumplir con la meta de "0 filtraciones" y asegurar la transacci√≥n, se requiere un mecanismo que valide matem√°ticamente que los datos (monto, moneda) no han sido manipulados.

---

## Alternativas

### 1. Encriptar datos (Solo HTTPS/TLS)
- **Descripci√≥n:** Cifrado est√°ndar en tr√°nsito.  
- **Desventaja:** Protege la confidencialidad del canal, pero no valida la integridad del mensaje individual si el canal es comprometido o si el ataque proviene del cliente mismo.

### 2. Autenticar a los actores (MFA)
- **Descripci√≥n:** Verificar identidad del usuario (MFA).  
- **Desventaja:** Asegura qui√©n env√≠a el mensaje, pero no garantiza qu√© contiene el mensaje (no protege la integridad del payload).

### 3. Verificar integridad de mensajes (HMAC)
- **Descripci√≥n:** Implementar firmas digitales tipo `HMAC-SHA256` sobre el payload del pago.  
- **Ventaja:** Crea un sello criptogr√°fico √∫nico para cada transacci√≥n. Cualquier cambio en los datos (p. ej., modificar el monto) invalida la firma.

### 4. Limitar exposici√≥n (API Gateway)
- **Descripci√≥n:** Ocultar o filtrar endpoints sensibles en el gateway.  
- **Desventaja:** Es seguridad por oscuridad; no protege si el endpoint es descubierto o el payload es manipulado desde el cliente.

---

## Criterios de Elecci√≥n
- **Integridad Absoluta:** Garant√≠a de que el monto cobrado es el monto autorizado.  
- **Defensa en Profundidad:** Capa de seguridad adicional sobre HTTPS.  
- **Prevenci√≥n de Fraude:** Detecci√≥n inmediata de manipulaci√≥n de datos.  
- **Performance:** Bajo impacto en el tiempo de respuesta.

---

## Decisi√≥n
Se elige la t√°ctica de Verificar integridad de mensajes (HMAC), complementando el cifrado est√°ndar en transporte (HTTPS/TLS).

---

## Sustento
- Aunque el escenario menciona "datos cifrados", la integridad es el componente cr√≠tico para evitar manipulaci√≥n fraudulenta de par√°metros de pago.  
- `HMAC-SHA256` permite sellar el payload de la transacci√≥n de forma que **cualquier alteraci√≥n** invalide la firma, ofreciendo:

  - **Integridad:** los datos viajan "sellados".  
  - **No repudio parcial:** junto con trazas y autenticaci√≥n, ayuda a justificar operaciones.  
  - **Defensa en profundidad:** suma una capa sobre TLS, protegiendo contra manipulaciones del payload incluso si el canal es comprometido o el cliente est√° comprometido.  
  - **Bajo costo computacional:** HMAC es eficiente y tiene impacto m√≠nimo en latencia.

- Con HMAC + HTTPS se logra un entorno de transacci√≥n segura, siendo esta combinaci√≥n m√°s efectiva frente a la manipulaci√≥n de par√°metros que confiar √∫nicamente en el t√∫nel TLS.

---

## **Escenario 2 ‚Äì Disponibilidad de los pagos**

| COD Escenario | Fuente Est√≠mulo | Est√≠mulo | Artefacto | Entorno | Respuesta | Medida de Respuesta | Comentario |
|---------------|-----------------|-----------|------------|-----------|------------|----------------------|-------------|
| ESC-11 | Usuario premium | Usuario premium intenta pagar mediante Stripe, pero Stripe est√° ca√≠do. | Gesti√≥n de Planes y Suscripciones | Operaci√≥n normal | Disponibilidad aunque la API externa de pago se haya ca√≠do. | Disponibilidad mantenida al 99.99%. | El CTO quiere permitir al usuario realizar el pago mediante una alternativa. |


---

## Documentaci√≥n de la Decisi√≥n (ADR)

### T√≠tulo
Selecci√≥n entre t√°cticas de disponibilidad para tolerar fallas externas en pagos (Stripe) dentro del m√≥dulo de Gesti√≥n de Planes y Suscripciones.

---

### Contexto

El m√≥dulo de Gesti√≥n de Planes y Suscripciones depende de Stripe para procesar pagos en l√≠nea.  
Sin embargo, Stripe es un servicio externo, por lo que:

- Puede experimentar ca√≠das.  
- Puede responder con latencia extrema.  
- Su falla afecta directamente a la capacidad del usuario de completar la suscripci√≥n.

El CTO ha solicitado expl√≠citamente que el usuario no quede bloqueado, y que exista una alternativa de pago habilitada cuando Stripe no est√© disponible.

---

### Alternativas

#### 1. Colocar intermediarios (Circuit Breaker + Fallback) ‚Äî *Opci√≥n elegida*
- Detecta fallas de Stripe y abre el circuito tras repetidos errores o timeouts.  
- Evita saturar el backend con llamadas fallidas.  
- Ofrece un medio de pago alternativo (p. ej., pago contra-transferencia, pago offline, otro gateway secundario).  
- Permite que el usuario complete la operaci√≥n sin ver errores t√©cnicos.

#### 2. Reintento autom√°tico (Retry Pattern)
- Reintenta el pago tras fallos temporales.  
- √ötil solo cuando Stripe responde lento, pero ineficaz durante una ca√≠da real.  
- Puede incrementar la latencia y frustraci√≥n del usuario.

#### 3. Colocar colas (Message Queue)
- Permite diferir el procesamiento del pago.  
- √ötil para pagos as√≠ncronos, pero en suscripciones el usuario necesita confirmaci√≥n inmediata.

#### 4. Replicaci√≥n de servicio
- No aplica, ya que Stripe es una dependencia externa y no puede replicarse internamente.

#### 5. Degradaci√≥n controlada
- Mostrar un mensaje indicando que el pago no est√° disponible temporalmente.  
- Evita errores, pero no cumple con el requerimiento del CTO de permitir un m√©todo de pago alternativo.

---

### Criterios de Elecci√≥n

- Mantener el pago disponible incluso si Stripe falla.  
- Evitar bloqueos en UI y backend.  
- Prevenir saturaci√≥n del backend por timeouts repetidos.  
- Mantener una experiencia fluida para el usuario premium.  
- Minimizar impacto operativo y de mantenimiento.

---

### Decisi√≥n

Se selecciona la t√°ctica **Circuit Breaker**, implementada como:

- **Circuit Breaker** para proteger al backend de fallas continuas de Stripe.  
- **Fallback autom√°tico** hacia un m√©todo de pago alternativo cuando Stripe est√© inoperativo.

---

### Sustento

El **Circuit Breaker** permite:

- Detectar fallas recurrentes.  
- Cortar el tr√°fico hacia Stripe mientras el proveedor est√° ca√≠do.  
- Evitar que los hilos del backend se bloqueen.

El **fallback** garantiza:

- El usuario s√≠ puede completar el pago, cumpliendo la solicitud del CTO.  
- Se mantiene la operatividad del sistema sin depender al 100% de un proveedor externo.  
- Se evita impacto negativo en las m√©tricas de conversi√≥n y satisfacci√≥n del usuario.

---

## **Escenario 3 ‚Äì Mantenibilidad ante Errores de Facturaci√≥n**

| Cod Escenario | Atributo de Calidad | Fuente del Est√≠mulo | Est√≠mulo                                | Artefacto                                  | Entorno            | Respuesta                                   | Medida de Respuesta          |
|----------------|--------------------|----------------------|------------------------------------------|--------------------------------------------|--------------------|---------------------------------------------|-------------------------------|
| ESC-12         | Mantenibilidad     | Usuario afectado     | Reporta cobro duplicado o error de facturaci√≥n | M√≥dulo de Gesti√≥n de Planes y Suscripciones | Entorno de soporte | Soporte accede a logs y corrige transacci√≥n | Tiempo de resoluci√≥n < 24 h. |

---

### **Documentaci√≥n de la Decisi√≥n (ADR)**

#### **T√≠tulo**
Elecci√≥n entre **Encapsulamiento** vs **Abstracci√≥n de Servicios Comunes** para facilitar la correcci√≥n de errores de facturaci√≥n.

#### **Contexto**
Los errores en transacciones deben resolverse r√°pidamente sin afectar la operaci√≥n del sistema.  
El equipo de soporte necesita acceder a los registros, identificar el m√≥dulo afectado y aplicar correcciones sin generar efectos colaterales en otros servicios.

#### **Alternativas**
1. **Encapsulamiento:** aislar las funciones cr√≠ticas (procesamiento, validaci√≥n y registro de pagos) en clases y servicios separados.  
2. **Abstracci√≥n de servicios comunes:** centralizar operaciones repetitivas en servicios reutilizables.  


#### **Criterios de Elecci√≥n**
- Tiempo de resoluci√≥n.  
- Facilidad para localizar el error.  
- Impacto en otros m√≥dulos.  
- Costo de mantenimiento.

#### **Decisi√≥n**
Se elige **Encapsulamiento** como t√°ctica principal.

#### **Sustento**
Encapsular la l√≥gica de negocio del procesamiento de pagos permite aislar los errores y **corregirlos sin interrumpir otras operaciones**.  
Mejora la **trazabilidad**, facilita las **pruebas unitarias** y acelera la **atenci√≥n de incidencias**, cumpliendo con la meta de resolverlas en menos de 24 horas.

---


[‚¨ÖÔ∏è Anterior](../5.2/5.2.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../5.4/5.4.md)